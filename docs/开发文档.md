# Mai-Soul-Engine 开发文档

这份文档面向“要二次开发/要理解内部机制/要做生产运维”的读者。  
如果你只是想装上就跑，请看 `README.md`。

---

## 1. 总体目标（落地版）

Mai-Soul-Engine 的目标不是“记录关键词”，而是把群聊的**语义氛围**转成一套可演化的“人格底色”，并让它以三种方式可感知：

1) **光谱（System A）**：四轴坐标随群聊语义产生连续位移（偏向、强弱、波动）。  
2) **思维阁（System B）**：热议话题被抓取为思维种子，经过多轮“品鉴”，固化为稳定 Trait，并产生明显的长期影响。  
3) **黑盒（System C）**：Dream 期间的思考过程/潜意识片段被记录为“意识流”，用于外部展示与后续对话的隐性风格参考。  

同时提供一组 `/api/v1/soul/*` 的只读接口，供前端做可视化（规范见 `前端需求.md`）。

---

## 2. 运行约束与设计原则

### 2.1 约束
- **不修改 MaiBot 主程序文件**：所有 Dream 联动通过运行时 hook 完成。  
- 插件必须“轻量”：不能阻塞 Dream 主流程；失败要能兜底。  
- 任何展示/存储内容都应做**脱敏/截断**（避免泄露原句、链接、号码、邮箱等）。  

### 2.2 设计原则
- **Dream 窗口批处理**代替逐条消息打分：降低成本、提高语义稳定性。  
- “可观测”优先：前端/运维能看见系统在干什么，才能调参。  
- 生产安全优先：API 写操作默认关闭，global 模式必须有护栏。  

---

## 3. 架构概览

插件代码入口：`plugin.py`（单文件实现，按模块分区组织）

核心组件：
- **SoulEngine**：状态容器、锁、持久化、Dream hook、API 路由、后台 sweep。
- **GroupSoulState**：按 `stream_id` 保存每个群的光谱/思维阁/黑盒/社交画像状态。
- **Global State**：当 `scope.default_scope=global` 时启用全局底色偏移与全局 traits。

数据流（Dream 全绑定模式）：
1) on_message：只做“脱敏 + 缓存到 pending_messages”
2) Dream start：
   - 光谱窗口批处理：pending_messages → LLM → group_deltas/topics/users/tags/summary
   - 写入：values/ema/volatility、influences、quote_bank、tag_cloud、slot seeds、dream_trace
3) Dream 中：
   - 思维阁品鉴：slot fragments → LLM evaluator → ripeness 增长 → 内化/固化 trait
   - 黑盒：生成潜意识片段（可选），并把 Dream trace 合并输出给前端
4) Dream end：记录 cycle end / theme / fragments_generated

---

## 4. System A：光谱（Ideological Spectrum）

### 4.1 四轴定义
- `sincerity_absurdism`：建构/解构  
- `normies_otakuism`：现充/二次元  
- `traditionalism_radicalism`：传统/赛博激进  
- `heroism_nihilism`：英雄/虚无  

内部数值区间是 `[-1, 1]`，前端展示通常缩放到 `[-100, 100]`。

### 4.2 更新模式：Dream Window（默认）
配置：`[spectrum].update_mode = "dream_window"`

逻辑：
- 群消息进入 `pending_messages`（脱敏/截断）
- Dream 周期开始时，取窗口消息（上次 Dream → 本次 Dream），一次性喂给 LLM
- LLM 返回 `group_deltas`（四轴位移）与 `confidence/intensity`
- 用强度/置信度/窗口规模系数计算 effective，然后更新：
  - `values`：当前坐标
  - `ema`：平滑坐标
  - `recent_deltas`：用于波动率（volatility）
  - `tag_cloud/quote_bank/influences`：用于社会化学习与雕刻师

### 4.3 回归阻力（人格不被刷屏带跑）
配置：`[spectrum].regression_rate`

每次更新后，`values` 会向 `base_tone`（或 global offset 叠加后的底色）回归一点点。

---

## 5. System B：思维阁（Thought Cabinet / 意识形态实验室）

### 5.1 “种子出现”（Sampling）
在 Dream 窗口分析里，LLM 会返回 `topics[]`：
- `topic`：话题名称（短）
- `tags`：标签
- `energy`：热度（0~1）
- `fragments`：抽象转述的上下文切片（避免原句复刻）

插件根据阈值创建 `ThoughtSlot`（占用一个槽位），并写入：
- `seed_topic/seed_tags/fragments/energy/keyword_cloud`
- `status`：`awaiting_seed_approval` 或 `fermenting`

### 5.2 “品鉴与发酵”（Mastication）
在 Dream 静默时刻（或 Dream 周期）执行多轮 evaluator：
- 输入：slot fragments + 当前坐标快照 + 已固化 traits 概览
- 输出：四轴 deltas、verdict、logic_points、trait_name/style_hint、confidence

累积逻辑：
- 多轮输出的 deltas 叠加到 `deltas_sum`
- `ripeness`（成熟度）逐步增长，达到 100% 进入“可内化”

### 5.3 “固化”（Assimilation）
当满足内化条件：
- 生成 `ThoughtTrait`：保存 verdict/style_hint/shift/tags/topic/digest/definition 等
- 将 `shift` 投射到光谱：
  - 可选择只改 base_tone（长期）或同时改 values/ema（立刻）
- 写入 Dream trace（用于黑盒 UI）

### 5.4 Rethink（重新反思，可选）
配置：`cabinet.rethink_enabled=true`

已固化 trait 也可以在后续 Dream 周期基于“当下立场”重新生成思想定义/内化结果，并保留少量历史。

### 5.5 global 内化护栏（生产必配）
当 `scope.default_scope="global"` 时，内化会影响跨群共享的全局底色偏移：
- `cabinet.global_whitelist_targets`：允许影响全局的群白名单
- `cabinet.global_daily_shift_cap_abs`：每天每轴最大累计偏移
- `cabinet.global_min_slot_energy` / `cabinet.global_min_avg_confidence`：质量门槛

---

## 6. System C：黑盒（Black Box）

黑盒输出用于“前端图4”：
- 潜意识片段：定期生成（可绑定 Dream）
- Dream 思考日志：把“窗口分析/品鉴轮次/固化结果/反思”等写入 `dream_trace`

前端接口 `GET /api/v1/soul/fragments` 会合并输出：
- `fragments`（潜意识片段）
- `dream_trace`（Dream 思考日志）

---

## 7. 社会化学习（雕刻师/社交画像/群体语言画像）

### 7.1 灵魂雕刻师（/sculptors）
- 每个窗口分析返回 `users[]`：贡献向量、转述 quote、tags  
- 插件累计到 `InfluenceProfile`：
  - `score`：影响力分数（不含管理员倍数，便于展示）
  - `multiplier`：权重乘子（管理员/配置）
  - `contrib`：贡献向量（四轴）
  - `display_name/quote/tag_counts` 等

### 7.2 /social
- `tag_cloud`：群整体标签云
- `quote_tail`：代表语录（转述）
- `prototypes/top_users`：可选派系原型与用户画像

### 7.3 sociolect（可选）
用于“群体语言习惯反向喂给回复”，默认关闭：
- `sociolect.enabled=false`
- 开启后会周期性总结群体语言规则/避讳/词汇倾向，可选注入回复提示词

---

## 8. 提示词注入（让回复可感知）

插件会在回复提示词里加入一段“意识形态提示词块”：
- 四轴倾向：**6 档力度曲线**（从“几乎中立”到“压倒性倾向”）
- 命中相关话题时：注入固化 trait 的 `definition + digest`（更有味道）
- 明确约束：不要显式提及系统名/数值，不模仿任何具体用户

---

## 9. API 设计（前端对接）

接口前缀：`/api/v1/soul`

鉴权：
- `api.token` 为空：不鉴权（不推荐）
- `api.token` 非空：需要 `Authorization: Bearer ...` 或 `X-Soul-Token: ...`

返回结构：
- GET 默认返回前端友好结构（对齐 `前端需求.md`）
- `format=raw` 可返回原始调试结构
- `scope=local|global`（默认 local；兼容 group=local）

---

## 10. 持久化与隐私

状态文件：`plugins/MaiBot_Soul_Engine/data/state.json`

持久化内容：
- group：values/ema/base_tone/recent_deltas、slots、traits、dissonance、fragments、dream_trace、influences 等
- global：global_base_offset/global_traits/daily_cap 等

隐私策略：
- pending_messages/fragments/quotes 均进行脱敏与长度截断
- 禁止原句复刻（LLM prompt 里也有硬性要求）

---

## 11. 开发与验收建议（实操）

### 11.1 推荐的验收顺序
1) 先验证 Dream hook：`GET /api/v1/soul/pulse?scope=global`
2) 群里聊天几分钟 → 等一次 Dream → 看光谱是否位移：`/soul status` 或 `GET /spectrum`
3) 看是否出现 seeds/slots：`GET /cabinet`
4) 看黑盒日志是否在更新：`GET /fragments`
5) 看雕刻师是否有 Top5：`GET /sculptors`

### 11.2 常用调参项（最影响“能不能触发/触发频率”）
- 光谱：`spectrum.window_strength_scale`（越小越容易有明显位移）
- 思维阁热点：`cabinet.seed_energy_threshold / seed_min_occurrences / context_window_messages`
- 静默：`cabinet.quiet_period_seconds`
- 品鉴轮数与间隔：`cabinet.mastication_required_runs / mastication_interval_seconds`

---

## 12. 版本与兼容性

版本号：
- `_manifest.json` 的 `version`
- `config.toml` 的 `plugin.config_version`

建议：
- 任何破坏性字段改动都要同时更新：README + 开发文档 + 前端需求对齐说明

