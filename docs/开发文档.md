# Mai‑Soul‑Engine 开发文档（对内）

目标读者：负责实现/维护该插件的开发者（含 AI）。  
本插件已经明确为**“思维内省系统”**：不依赖任何外部机制，也不做逐条消息打分。所有演化发生在“思维内省”周期中。

---

## 0. 不变量（必须遵守）

1) **不修改 MaiBot 主程序**：不得改 `MaiBot/src/**`。所有功能通过插件事件与 API 路由实现。  
2) **隐私脱敏**：持久化与 API 输出不得包含可识别个人信息、链接/号码/邮箱、以及可复刻的原句长文本；`pending_messages` 不落盘真实用户名/账号（用户与群标识哈希化）。  
3) **LLM 输出必须结构化**：所有关键链路必须要求严格 JSON 输出，并在解析失败时安全降级。  
4) **生产安全**：对外 API 必须支持 token 鉴权；状态写操作默认不提供远程接口。  
5) **状态有上限**：消息缓存、日志、种子队列、槽位都必须 cap，避免 `state.json` 无限增长。  

---

## 1. 系统概览

### 1.1 三大模块

1) 思想光谱（Spectrum）  
四轴量化立场，范围 `-100~+100`（对外），内部归一化为 `-1~+1`。用于：
- 展示当前底色
- 在回复注入中按档位影响表达

2) 思维阁（Thought Cabinet）  
由两类对象组成：
- **思想种子（Seed）**：内省末轮生成，进入 `seed_queue`，等待后续内省内化
- **固化思想（Thought）**：内化完成后进入 `thoughts`，并产生一次“明显偏移”

3) 思维内省（Introspection）  
定期对指定时间窗内的聊天记录进行多轮回想，输出：
- 每轮“内心独白 + 要点”
- 最终轮“光谱偏移量 + 新思想种子”

### 1.2 数据流（核心闭环）

1) `ON_MESSAGE`：只做脱敏缓存到 `pending_messages`  
2) `tick_background`：判断是否满足触发条件（静默 + 到达间隔 + 有新内容或有待内化 seed）  
3) `introspection_run`：
   - 先内化 `seed_queue` 前 N 条 → 固化进 `thoughts` → 产生一次宏偏移
   - 再对聊天时间窗进行 N 轮内省 → 最终轮输出微偏移 + 新 seed 入队
   - 写入 `introspection_logs`（用于 API 展示）
4) `POST_LLM`：注入“光谱档位倾向 + 相关固化思想（定义/结论）”

---

## 2. 思想光谱（Spectrum）

### 2.1 四轴定义（内部键 / 前端键）

| 内部 key | 前端 axis | 含义（负向 ←→ 正向） |
|---|---|---|
| `sincerity_absurdism` | `sincerity-absurdism` | 严肃建构 ←→ 抽象解构 |
| `normies_otakuism` | `normies-otakuism` | 现充主义 ←→ 二次元沉溺 |
| `traditionalism_radicalism` | `traditionalism-radicalism` | 传统保守 ←→ 赛博激进 |
| `heroism_nihilism` | `heroism-nihilism` | 热血英雄主义 ←→ 虚无主义 |

### 2.2 档位曲线（温和）

按绝对值点数分档（用于注入强度），满足你提出的“5~25 才是第一档”：

- `0~5`：几乎中立（基本不影响）
- `5~25`：第 1 档（轻微影响）
- `25~50`：第 2 档（偏向）
- `50~75`：第 3 档（明显）
- `75~100`：第 4 档（强烈）

实现入口：`SoulEngine._tier_by_points_abs()`（`plugins/MaiBot_Soul_Engine/plugin.py`）。

### 2.3 偏移应用

偏移单位为点（`-100~+100`），转换为内部 `delta = points/100`，并结合：
- `intensity/confidence`（LLM 输出）
- `window_size`（消息量 log 缩放）
- `spectrum.regression_rate`（向 base_tone 回归）
- `spectrum.ema_alpha`（平滑）

实现入口：`SoulEngine._apply_shift_locked()`。

---

## 3. 思维内省（Introspection）

### 3.1 触发条件（后台调度）

每 5 秒 tick 一次（后台任务 `MaiSoulIntrospectionBackground`），对每个群判断：
- `now - last_introspection_ts >= interval_minutes`
- 静默：`now - last_activity_ts >= quiet_period_seconds`
- 且满足其一：
  - `seed_queue` 非空（优先用于内化）
  - 窗口内可用消息条数 `>= introspection.min_messages_to_run`

配置：
- `introspection.interval_minutes`
- `introspection.quiet_period_seconds`
- `introspection.max_groups_per_tick`
- `introspection.min_messages_to_run`

### 3.2 输入窗口

窗口从 `pending_messages` 抽取：
- 时间范围：`max(now-window_minutes, last_introspection_ts)`
- 最多条数：`introspection.max_messages_per_group`

实现入口：`SoulEngine._extract_window_locked()`。

### 3.3 多轮输出（LLM JSON 契约）

内省轮数 `introspection.rounds`（>=2）：
- 非最终轮：
  - `monologue`（60~220 字内心独白）
  - `notes`（1~6 条要点）
- 最终轮额外输出：
  - `spectrum_shift_points`（四轴点数）
  - `seed_topics[]`（topic/tags/energy/fragments）
  - `confidence/intensity`

实现入口：`SoulEngine._introspection_run()`（`mai_soul_engine.introspection.round.*`）。

### 3.4 隐私约束（必须写进 prompt）

每轮 prompt 必须包含硬性要求：
- 不输出群名、任何可识别个人信息、链接/号码/邮箱
- 不复刻原句（包括 fragments）

---

## 4. 思维阁（Thought Cabinet）

### 4.1 Seed 队列

内省最终轮生成的 `seed_topics` 会进入 `seed_queue`（去重、能量阈值、cap）。

配置：
- `cabinet.seed_energy_threshold`
- `cabinet.max_seed_queue`

### 4.2 内化固化（在内省周期内执行）

每次内省最先处理 seed 队列：
- 取 `cabinet.internalize_seeds_per_run` 条
- 对每条 seed 执行 `cabinet.internalization_rounds` 多轮内化
- 最终轮输出：
  - `name/definition/digest/style_hint`
  - `impact_points`（宏偏移点数）
  - `tags/confidence/intensity`

固化后：
- 写入 `thoughts`（cap= `cabinet.max_slots`）
- 立即对光谱应用一次宏偏移
- 写入 `introspection_logs`

实现入口：`SoulEngine._internalize_seed()`。

---

## 5. 回复注入（POST_LLM）

注入块包含：
- 光谱档位倾向（不报数值）
- 相关固化思想（definition + digest，最多 N 条）

相关性选择：当前实现使用 topic/tag 的简单匹配（可后续替换为 embedding 相似度）。  
实现入口：`SoulEngine.build_injection_block()`。

配置：
- `injection.enabled`
- `injection.max_thought_details`
- `injection.max_chars`

---

## 6. API（前端对接）

Base：`/api/v1/soul`

鉴权：
- `api.token` 为空：不鉴权（不建议）
- 非空：`Authorization: Bearer <token>` 或 `X-Soul-Token: <token>`

端点（当前插件实现）：
- `GET /api/v1/soul/spectrum`
- `GET /api/v1/soul/cabinet`
- `GET /api/v1/soul/introspection`（思维内省日志）
- `GET /api/v1/soul/pulse`
- `GET /api/v1/soul/targets`
- 兼容：`GET /api/v1/soul/fragments` 指向 `/introspection`

---

## 7. 持久化（JSON）

文件：`plugins/MaiBot_Soul_Engine/data/state.json`

存储内容（按群）：
- `pending_messages`（脱敏 + cap）
- `values/ema/base_tone/recent_deltas`
- `last_introspection_ts`
- `introspection_logs`（cap）
- `seed_queue` / `thoughts`

---

## 8. 本地验收（给 AI / 开发者）

1) 启动 MaiBot 并确认插件加载  
2) 群里聊天几分钟，等待静默或手动触发  
3) 开启调试后执行：
- `/soul status`：查看 pulse（包含 next_run）
- `/soul introspect`：强制跑一次内省
4) 调接口验证：
- `GET /api/v1/soul/introspection`：应出现多轮独白日志
- `GET /api/v1/soul/spectrum`：数值发生变化
- `GET /api/v1/soul/cabinet`：可能出现 seed 与固化思想
