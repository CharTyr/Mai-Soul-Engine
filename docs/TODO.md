# Mai‑Soul‑Engine TODO（对内）

说明：
- 本文件用于追踪“推倒重构”后的后续增强项（含与 MaiBot 主程序协作点）。
- **不修改 MaiBot 主程序**（`MaiBot/src/**`）仍为不变量；所有集成通过插件事件、注入与运行时工具注册完成。

---

## P0（优先做，直接影响“能用/好用/稳定”）

- [x] **固化思想 → 记忆库同步（方案 B）**：运行时注册 Memory Retrieval 工具（`soul_search_thoughts` / `soul_get_thought`），用于在需要时检索固化思想并供主程序调用
- [x] **回复前确定性 TopN 注入**：不依赖 LLM 是否调用工具；每次回复前本地检索相关固化思想 TopN，直接注入 replyer 提示词（受 `injection.max_chars` / prompt budget 控制）
- [x] **与主程序 planner 的兜底兼容**：当 `planner_question` 导致 memory retrieval skip 时，仍能通过“确定性 TopN 注入”保证“思想可被用到”
- [x] **思想检索索引**：为固化思想建立轻量索引（tags/关键词/简易 BM25），保证 TopN 检索稳定且低开销
- [x] **持久化一致性进一步增强**：增加 `state.json` schema_version + 迁移框架（向后兼容），并在损坏时自动回滚到可用快照
- [x] **生产运维安全**：为“写状态类”调试命令提供更严格的开关/权限校验与审计日志（默认关闭）

---

## P1（体验增强，提升可控性/可解释性）

- [x] **思想种子去重/合并策略升级**：基于 tags + 主题相似度合并；避免同一话题重复占用 seed_queue
- [x] **固化思想“老化/降权”机制**：随时间衰减检索分数/注入概率，避免旧思想长期霸占注入位
- [x] **光谱解释性增强**：输出“本次内省驱动偏移的关键理由摘要”（仍需脱敏、不可复刻原句）
- [x] **更精细的注入策略**：按对话意图选择注入类型（立场/观点/口吻），并支持“仅在争议话题注入”
- [x] **更强的失败降级**：LLM JSON 解析失败时，回退到更短 prompt + 更少轮数（不丢失持久化一致性）

---

## P2（可观测性 / 易维护）

- [x] **健康检查与指标**：`/api/v1/soul/health`、队列长度、最近内省耗时、失败率（不输出敏感信息）
- [x] **导入/导出**：仅导出脱敏后的“思想/光谱快照/内省日志摘要”，用于迁移或备份
- [x] **前端联动增强**：前端新增“思想检索/引用”展示与“注入命中”可视化（后端新增只读字段/端点）

---

## 已完成（追踪记录）

- [x] 按模型能力自适应 `max_tokens` + 提示词长度预算 + 自动降级/分段总结
- [x] 持久化可靠性（原子写入、备份回滚）
- [x] `/spectrum` 的 `base_tone` / `dominant_trait` / `last_major_shift` 计算逻辑补全
- [x] 更强脱敏（长数字/群号/QQ/手机号等模式），用户名不落盘、ID 哈希化（含持久化 salt）
- [x] 思维内省触发增加“最少消息条数”门槛（不仅仅是时间触发）
