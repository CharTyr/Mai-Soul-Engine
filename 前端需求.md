# Soul API 接口文档

> 前端 API 需求规范，供后端开发参考

## 概述

### Base URL
```
/api/v1/soul
```

### 通用参数

| 参数 | 类型 | 说明 |
|------|------|------|
| `stream_id` | `string` | 会话 ID（优先级高于 `target`） |
| `target` | `string` | 会话显示名（群名/会话名），用于从已知会话中匹配 |
| `limit` | `number` | 分页限制 |
| `offset` | `number` | 分页偏移 |

---

## 1. GET /api/v1/soul/spectrum

获取四轴光谱数据。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `stream_id` | `string` | 否 | 会话 ID |
| `target` | `string` | 否 | 会话显示名 |

### 响应结构

```typescript
interface SpectrumResponse {
  dimensions: SpectrumDimension[];
  base_tone: BaseTone;
  dominant_trait: string;
  last_major_shift: string;
  updated_at: string;
}

interface SpectrumDimension {
  axis: DimensionAxis;
  values: {
    current: number;      // -100 to 100
    ema: number;          // 指数移动平均
    baseline: number;     // 基线值
  };
  volatility: number;     // 波动率
}

interface BaseTone {
  primary: DimensionPole;
  secondary?: DimensionPole;
}
```

### 示例响应

```json
{
  "dimensions": [
    {
      "axis": "sincerity-absurdism",
      "values": { "current": 35, "ema": 28, "baseline": 20 },
      "volatility": 0.15
    },
    {
      "axis": "normies-otakuism",
      "values": { "current": -45, "ema": -38, "baseline": -30 },
      "volatility": 0.22
    },
    {
      "axis": "traditionalism-radicalism",
      "values": { "current": 60, "ema": 55, "baseline": 45 },
      "volatility": 0.18
    },
    {
      "axis": "heroism-nihilism",
      "values": { "current": -20, "ema": -15, "baseline": -10 },
      "volatility": 0.12
    }
  ],
  "base_tone": {
    "primary": "radicalism",
    "secondary": "absurdism"
  },
  "dominant_trait": "叛逆思想家",
  "last_major_shift": "2024-01-15T08:30:00Z",
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 2. GET /api/v1/soul/cabinet

获取思维阁数据（思想槽位、特质、认知失调）。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `stream_id` | `string` | 否 | 会话 ID |
| `target` | `string` | 否 | 会话显示名 |

### 响应结构

```typescript
interface CabinetResponse {
  slots: ThoughtSlot[];
  traits: CrystallizedTrait[];
  dissonance: CognitiveDissonance;
}

interface ThoughtSlot {
  id: string;
  name: string;
  source_dimension: DimensionPole;
  status: "internalizing" | "crystallized" | "conflicting";
  progress: number;           // 0-100 成熟度
  conflict_reason?: string;
  crystallized_at?: string;
  introspection: string;
  impacts: DimensionImpact[];
  debug_params?: Record<string, unknown>;
}

interface CrystallizedTrait {
  id: string;
  name: string;
  source_dimension: DimensionPole;
  crystallized_at: string;
  description: string;
  permanent_effects: DimensionImpact[];
}

interface CognitiveDissonance {
  active: boolean;
  conflicting_thoughts: string[];
  severity: "low" | "medium" | "high";
  triggered_at?: string;
}

interface DimensionImpact {
  dimension: DimensionAxis;
  direction: "left" | "right";
  strength: number; // -10 to 10
}

```

### 示例响应

```json
{
  "slots": [
    {
      "id": "thought-001",
      "name": "虚无主义的诱惑",
      "source_dimension": "nihilism",
      "status": "internalizing",
      "progress": 65,
      "introspection": "这种思想正在缓慢渗透...",
      "impacts": [
        { "dimension": "heroism-nihilism", "direction": "right", "strength": 3 }
      ]
    }
  ],
  "traits": [
    {
      "id": "trait-001",
      "name": "理性怀疑者",
      "source_dimension": "sincerity",
      "crystallized_at": "2024-01-10T00:00:00Z",
      "description": "对一切保持理性审视",
      "permanent_effects": [
        { "dimension": "sincerity-absurdism", "direction": "left", "strength": 2 }
      ]
    }
  ],
  "dissonance": {
    "active": false,
    "conflicting_thoughts": [],
    "severity": "low"
  }
}
```

---

## 3. GET /api/v1/soul/introspection

获取思维内省日志（对前端展示用）。

兼容：旧前端可继续调用 `GET /api/v1/soul/fragments`，其响应与本接口一致。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `limit` | `number` | 否 | 返回数量限制 |

### 响应结构

```typescript
interface FragmentsResponse {
  fragments: Fragment[];
  next_injection?: string;
  updated_at: string;
}

interface Fragment {
  id: string;
  content: string;
  source: FragmentSource;
  timestamp: string;
  tags: string[];
  redacted?: boolean;
  check_result?: "success" | "failure";
}

type FragmentSource = 
  | "introspection";
```

### 示例响应

```json
{
  "fragments": [
    {
      "id": "frag-001",
      "content": "（第 2 轮内省）我意识到争论的核心并不是对错，而是群里对“认真讨论”的期待不同。",
      "source": "introspection",
      "timestamp": "2024-01-20T03:00:00Z",
      "tags": ["内省", "意识形态", "冲突"],
      "redacted": false
    },
    {
      "id": "frag-002",
      "content": "[REDACTED]",
      "source": "introspection",
      "timestamp": "2024-01-19T23:00:00Z",
      "tags": ["内省"],
      "redacted": true
    }
  ],
  "next_injection": "2024-01-20T15:00:00Z",
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 4. GET /api/v1/soul/pulse

获取实时脉冲状态。

### 响应结构

```typescript
interface PulseResponse {
  temperature: number;
  life_state: LifeState;
  status: string;
  uptime: string;
  heartbeat: number;
  dissonance: {
    active: boolean;
    last_triggered?: string;
  };
  introspection: IntrospectionInfo;
  updated_at: string;
}

type LifeState = 
  | "active"
  | "idle"
  | "contemplating"
  | "distressed";

interface IntrospectionInfo {
  enabled: boolean;
  last_run?: string;
  next_run?: string;
}
```

### 示例响应

```json
{
  "temperature": 0.72,
  "life_state": "contemplating",
  "status": "思维内省系统运行中",
  "uptime": "72h 15m",
  "heartbeat": 42,
  "dissonance": {
    "active": false
  },
  "introspection": {
    "enabled": true,
    "last_run": "2024-01-20T03:00:00Z",
    "next_run": "2024-01-20T15:00:00Z"
  },
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 5. GET /api/v1/soul/targets

获取会话列表。

### 响应结构

```typescript
interface TargetsResponse {
  targets: Target[];
  updated_at: string;
}

interface Target {
  stream_id: string;
  target: string;
  target_type: "group" | "private" | "channel";
  last_activity: string;
  message_count: number;
}
```

### 示例响应

```json
{
  "targets": [
    {
      "stream_id": "stream-001",
      "target": "哲学讨论群",
      "target_type": "group",
      "last_activity": "2024-01-20T11:45:00Z",
      "message_count": 1024
    },
    {
      "stream_id": "stream-002",
      "target": "私聊-思想家A",
      "target_type": "private",
      "last_activity": "2024-01-20T10:30:00Z",
      "message_count": 256
    }
  ],
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 附录

### A. 枚举类型定义

#### DimensionAxis
```typescript
type DimensionAxis = 
  | "sincerity-absurdism"     // 真诚-荒诞
  | "normies-otakuism"        // 常人-宅系
  | "traditionalism-radicalism" // 传统-激进
  | "heroism-nihilism";       // 英雄-虚无
```

#### DimensionPole
```typescript
type DimensionPole = 
  | "sincerity" | "absurdism"
  | "normies" | "otakuism"
  | "traditionalism" | "radicalism"
  | "heroism" | "nihilism";
```

### B. 错误响应格式

```typescript
interface ErrorResponse {
  error: {
    code: string;
    message: string;
    details?: Record<string, unknown>;
  };
}
```

### C. HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---
