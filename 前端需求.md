# Soul API 接口文档

> 前端 API 需求规范，供后端开发参考

## 概述

### Base URL
```
/api/v1/soul
```

### 通用参数

| 参数 | 类型 | 说明 |
|------|------|------|
| `scope` | `"local" \| "global"` | 数据范围，默认 `local` |
| `limit` | `number` | 分页限制 |
| `offset` | `number` | 分页偏移 |

---

## 1. GET /api/v1/soul/spectrum

获取四轴光谱数据。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `scope` | `"local" \| "global"` | 否 | 数据范围 |

### 响应结构

```typescript
interface SpectrumResponse {
  dimensions: SpectrumDimension[];
  base_tone: BaseTone;
  dominant_trait: string;
  last_major_shift: string;
  updated_at: string;
}

interface SpectrumDimension {
  axis: DimensionAxis;
  values: {
    current: number;      // -100 to 100
    ema: number;          // 指数移动平均
    baseline: number;     // 基线值
  };
  volatility: number;     // 波动率
}

interface BaseTone {
  primary: DimensionPole;
  secondary?: DimensionPole;
  global_offset?: number; // scope=global 时存在
}
```

### 示例响应

```json
{
  "dimensions": [
    {
      "axis": "sincerity-absurdism",
      "values": { "current": 35, "ema": 28, "baseline": 20 },
      "volatility": 0.15
    },
    {
      "axis": "normies-otakuism",
      "values": { "current": -45, "ema": -38, "baseline": -30 },
      "volatility": 0.22
    },
    {
      "axis": "traditionalism-radicalism",
      "values": { "current": 60, "ema": 55, "baseline": 45 },
      "volatility": 0.18
    },
    {
      "axis": "heroism-nihilism",
      "values": { "current": -20, "ema": -15, "baseline": -10 },
      "volatility": 0.12
    }
  ],
  "base_tone": {
    "primary": "radicalism",
    "secondary": "absurdism"
  },
  "dominant_trait": "叛逆思想家",
  "last_major_shift": "2024-01-15T08:30:00Z",
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 2. GET /api/v1/soul/cabinet

获取思维阁数据（思想槽位、特质、认知失调）。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `scope` | `"local" \| "global"` | 否 | 数据范围 |

### 响应结构

```typescript
interface CabinetResponse {
  slots: ThoughtSlot[];
  traits: CrystallizedTrait[];
  dissonance: CognitiveDissonance;
  global?: CabinetGlobalInfo; // scope=global 时存在
}

interface ThoughtSlot {
  id: string;
  name: string;
  source_dimension: DimensionPole;
  status: "internalizing" | "crystallized" | "conflicting";
  progress: number;           // 0-100 成熟度
  conflict_reason?: string;
  crystallized_at?: string;
  introspection: string;
  impacts: DimensionImpact[];
  debug_params?: Record<string, unknown>;
}

interface CrystallizedTrait {
  id: string;
  name: string;
  source_dimension: DimensionPole;
  crystallized_at: string;
  description: string;
  permanent_effects: DimensionImpact[];
}

interface CognitiveDissonance {
  active: boolean;
  conflicting_thoughts: string[];
  severity: "low" | "medium" | "high";
  triggered_at?: string;
}

interface DimensionImpact {
  dimension: DimensionAxis;
  direction: "left" | "right";
  strength: number; // -10 to 10
}

interface CabinetGlobalInfo {
  global_traits: CrystallizedTrait[];
  global_offset: Record<DimensionAxis, number>;
  daily_limit: number;
  whitelist: string[];
}
```

### 示例响应

```json
{
  "slots": [
    {
      "id": "thought-001",
      "name": "虚无主义的诱惑",
      "source_dimension": "nihilism",
      "status": "internalizing",
      "progress": 65,
      "introspection": "这种思想正在缓慢渗透...",
      "impacts": [
        { "dimension": "heroism-nihilism", "direction": "right", "strength": 3 }
      ]
    }
  ],
  "traits": [
    {
      "id": "trait-001",
      "name": "理性怀疑者",
      "source_dimension": "sincerity",
      "crystallized_at": "2024-01-10T00:00:00Z",
      "description": "对一切保持理性审视",
      "permanent_effects": [
        { "dimension": "sincerity-absurdism", "direction": "left", "strength": 2 }
      ]
    }
  ],
  "dissonance": {
    "active": false,
    "conflicting_thoughts": [],
    "severity": "low"
  }
}
```

---

## 3. GET /api/v1/soul/sculptors

获取灵魂塑造者排行榜。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `limit` | `number` | 否 | 返回数量限制 |
| `offset` | `number` | 否 | 分页偏移 |

### 响应结构

```typescript
interface SculptorsResponse {
  users: Sculptor[];
  updated_at: string;
}

interface Sculptor {
  id: string;
  name: string;
  avatar?: string;
  influence: number;        // 影响力分数
  weight: number;           // 权重
  is_admin: boolean;
  primary_impact: DimensionPole;
  contribution_vector: Record<string, number>;
  representative_quotes: RepresentativeQuote[];
}

interface RepresentativeQuote {
  content: string;
  timestamp: string;
  impact_score: number;
}
```

### 示例响应

```json
{
  "users": [
    {
      "id": "user-001",
      "name": "思想先驱",
      "avatar": "https://example.com/avatar.jpg",
      "influence": 156.8,
      "weight": 1.5,
      "is_admin": true,
      "primary_impact": "radicalism",
      "contribution_vector": {
        "sincerity-absurdism": 12.5,
        "traditionalism-radicalism": 45.2
      },
      "representative_quotes": [
        {
          "content": "打破常规才能看到真相",
          "timestamp": "2024-01-18T14:30:00Z",
          "impact_score": 8.5
        }
      ]
    }
  ],
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 4. GET /api/v1/soul/social

获取社交数据（标签云、语录库、派系原型）。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `limit` | `number` | 否 | 语录/用户数量限制 |

### 响应结构

```typescript
interface SocialResponse {
  tag_cloud: TagCloudItem[];
  quote_tail: QuoteRecord[];
  prototypes: Prototype[];
  top_users: UserProfile[];
  updated_at: string;
}

interface TagCloudItem {
  tag: string;
  count: number;
  weight: number;
  trend: "rising" | "stable" | "falling";
}

interface QuoteRecord {
  content: string;
  author_id: string;
  author_name: string;
  timestamp: string;
  impact_score: number;
  dimension_tags: DimensionPole[];
}

interface Prototype {
  id: string;
  name: string;
  description: string;
  dominant_dimensions: DimensionPole[];
  member_count: number;
  representative_tags: string[];
}

interface UserProfile {
  id: string;
  name: string;
  stability: number;        // 稳定度 0-100
  stance_mean: Record<DimensionAxis, number>;
  stance_variance: Record<DimensionAxis, number>;
  common_tags: string[];
}
```

### 示例响应

```json
{
  "tag_cloud": [
    { "tag": "解构主义", "count": 128, "weight": 0.85, "trend": "rising" },
    { "tag": "后现代", "count": 96, "weight": 0.72, "trend": "stable" }
  ],
  "quote_tail": [
    {
      "content": "意义是被赋予的，不是被发现的",
      "author_id": "user-002",
      "author_name": "虚无漫步者",
      "timestamp": "2024-01-20T11:30:00Z",
      "impact_score": 7.2,
      "dimension_tags": ["nihilism", "absurdism"]
    }
  ],
  "prototypes": [
    {
      "id": "proto-001",
      "name": "理性主义者",
      "description": "追求逻辑与证据的群体",
      "dominant_dimensions": ["sincerity", "traditionalism"],
      "member_count": 45,
      "representative_tags": ["逻辑", "证据", "科学"]
    }
  ],
  "top_users": [],
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 5. GET /api/v1/soul/sociolect

获取群体语言画像。

### 响应结构

```typescript
interface SociolectResponse {
  rules: LanguageRule[];
  taboos: LanguageTaboo[];
  vocabulary_tendencies: VocabularyTendency[];
  ready: boolean;
  updated_at: string;
}

interface LanguageRule {
  pattern: string;
  description: string;
  frequency: number;
}

interface LanguageTaboo {
  pattern: string;
  reason: string;
  severity: "soft" | "hard";
}

interface VocabularyTendency {
  category: string;
  preferred_terms: string[];
  avoided_terms: string[];
}
```

### 示例响应

```json
{
  "rules": [
    {
      "pattern": "反讽句式",
      "description": "使用反讽表达真实观点",
      "frequency": 0.35
    }
  ],
  "taboos": [
    {
      "pattern": "绝对化表述",
      "reason": "与群体怀疑精神冲突",
      "severity": "soft"
    }
  ],
  "vocabulary_tendencies": [
    {
      "category": "情感表达",
      "preferred_terms": ["荒诞", "虚无", "解构"],
      "avoided_terms": ["正能量", "积极向上"]
    }
  ],
  "ready": true,
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 6. GET /api/v1/soul/fragments

获取潜意识片段。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `limit` | `number` | 否 | 返回数量限制 |

### 响应结构

```typescript
interface FragmentsResponse {
  fragments: Fragment[];
  next_injection?: string;
  updated_at: string;
}

interface Fragment {
  id: string;
  content: string;
  source: FragmentSource;
  timestamp: string;
  tags: string[];
  redacted?: boolean;
  check_result?: "success" | "failure";
}

type FragmentSource = 
  | "subconscious" 
  | "memory" 
  | "inspiration" 
  | "breakdown" 
  | "rational" 
  | "absurd"
  | "dream";
```

### 示例响应

```json
{
  "fragments": [
    {
      "id": "frag-001",
      "content": "在梦境边缘徘徊的思绪...",
      "source": "dream",
      "timestamp": "2024-01-20T03:00:00Z",
      "tags": ["梦境", "潜意识"],
      "redacted": false
    },
    {
      "id": "frag-002",
      "content": "[REDACTED]",
      "source": "breakdown",
      "timestamp": "2024-01-19T23:00:00Z",
      "tags": ["崩溃"],
      "redacted": true
    }
  ],
  "next_injection": "2024-01-20T15:00:00Z",
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 7. GET /api/v1/soul/pulse

获取实时脉冲状态。

### 响应结构

```typescript
interface PulseResponse {
  temperature: number;
  life_state: LifeState;
  status: string;
  uptime: string;
  heartbeat: number;
  dissonance: {
    active: boolean;
    last_triggered?: string;
  };
  dream: DreamInfo;
  updated_at: string;
}

type LifeState = 
  | "active" 
  | "idle" 
  | "dreaming" 
  | "contemplating" 
  | "distressed";

interface DreamInfo {
  bound: boolean;
  hook_success: boolean;
  last_cycle?: {
    started_at: string;
    ended_at: string;
    theme: string;
    fragments_generated: number;
  };
}
```

### 示例响应

```json
{
  "temperature": 0.72,
  "life_state": "active",
  "status": "思维活跃中",
  "uptime": "72h 15m",
  "heartbeat": 42,
  "dissonance": {
    "active": false
  },
  "dream": {
    "bound": true,
    "hook_success": true,
    "last_cycle": {
      "started_at": "2024-01-20T02:00:00Z",
      "ended_at": "2024-01-20T06:00:00Z",
      "theme": "存在主义迷宫",
      "fragments_generated": 3
    }
  },
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 8. GET /api/v1/soul/targets

获取会话列表。

### 响应结构

```typescript
interface TargetsResponse {
  targets: Target[];
  updated_at: string;
}

interface Target {
  stream_id: string;
  target: string;
  target_type: "group" | "private" | "channel";
  last_activity: string;
  message_count: number;
}
```

### 示例响应

```json
{
  "targets": [
    {
      "stream_id": "stream-001",
      "target": "哲学讨论群",
      "target_type": "group",
      "last_activity": "2024-01-20T11:45:00Z",
      "message_count": 1024
    },
    {
      "stream_id": "stream-002",
      "target": "私聊-思想家A",
      "target_type": "private",
      "last_activity": "2024-01-20T10:30:00Z",
      "message_count": 256
    }
  ],
  "updated_at": "2024-01-20T12:00:00Z"
}
```

---

## 附录

### A. 枚举类型定义

#### DimensionAxis
```typescript
type DimensionAxis = 
  | "sincerity-absurdism"     // 真诚-荒诞
  | "normies-otakuism"        // 常人-宅系
  | "traditionalism-radicalism" // 传统-激进
  | "heroism-nihilism";       // 英雄-虚无
```

#### DimensionPole
```typescript
type DimensionPole = 
  | "sincerity" | "absurdism"
  | "normies" | "otakuism"
  | "traditionalism" | "radicalism"
  | "heroism" | "nihilism";
```

### B. 错误响应格式

```typescript
interface ErrorResponse {
  error: {
    code: string;
    message: string;
    details?: Record<string, unknown>;
  };
}
```

### C. HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---
