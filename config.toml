# Mai‑Soul‑Engine 配置（思维内省 / 思想光谱 / 思维阁）
#
# 这份配置文件是给“非开发者”也能看懂的：
# - 每个字段尽量写清楚“它影响什么”“推荐怎么填”“填错会怎样”
#
# 新手建议按顺序设置（从必须 → 可选）：
# 1) `[plugin].enabled`：是否启用插件
# 2) `[api].token`：WebUI/前端访问 API 的 token（生产环境必填）
# 3) `[introspection].interval_minutes`：内省间隔（越小越频繁、越耗模型/资源）
# 4) `[introspection].window_minutes`：每次内省回顾多长时间的聊天
# 5) `[introspection].rounds`：每次内省几轮（轮数越多越“像人回想”，也越耗）
# 6) `[introspection].use_main_personality`：是否读取主程序人格设定参与内省（推荐开启）
#
# 重要说明：
# - 插件对外 API Header：`X-Soul-Token: <token>`（见 `[api].token`）
# - 本插件只持久化脱敏后的摘要与状态到 JSON（默认 `data/state.json`），不会保存原始聊天全文
# - 生产环境请务必设置 token（否则任何人都能读 API）

[plugin]
# 总开关：false 时插件不做任何内省/注入/存储（但仍可被加载）
enabled = true

[api]
# WebUI/API 访问控制：
# - 留空：任何能访问到后端端口的人都能读 API（不建议）
# - 建议：设置一串随机长字符串（例如 32~64 位）
token = ""
# CORS 说明（无需额外配置）：
# - 若 token 为空：仅允许本机 Origin（localhost/127.0.0.1/[::1]）跨域读取，避免误暴露
# - 若 token 非空：自动允许任意 Origin（反射 Origin），便于前端跨域部署

[spectrum]
# 思想光谱内部是 -1~+1（对外展示会映射为 -100~+100）
# clamp_abs：每个轴的硬上限（1.0 表示最多到 ±100）
clamp_abs = 1.0
# 回归率：每轮内省后，立场会向“基线”回归一点点（越大越不容易被带跑）
regression_rate = 0.01
# EMA 平滑：越大越跟手，越小越稳定（0.1~0.2 较常用）
ema_alpha = 0.15
# 波动窗口：用于“波动率 volatility”的统计窗口（最近 N 次内省；越大越平滑，越小越敏感）
fluctuation_window = 30

[cabinet]
# 思维阁槽位数（固化思想的展示/注入上限）。默认 6。
max_slots = 6
# 候选思想种子队列上限（避免无限增长）
max_seed_queue = 30
# 种子阈值：内省末轮生成的候选议题，能量低于阈值则丢弃（0~1）
seed_energy_threshold = 0.5
# 种子合并阈值：当新生成的种子与队列中某条相似度 >= 阈值时，会“合并”为同一条
# - 目的：避免同一话题反复被生成，灌爆 seed_queue
# - 取值建议：0.5~0.75（越大越不容易合并）
seed_merge_threshold = 0.6
# 每个思想种子最多保留 fragments 条数（fragments 会被脱敏/截断）
max_seed_fragments = 12
# 每次内省最多内化多少个种子（建议 1~2，太高会很耗）
internalize_seeds_per_run = 1
# 思想种子内化失败最多重试次数（超出会丢弃该种子）
max_internalize_attempts = 3
# 每个种子内化需要几轮（越高越“深入”，也越耗）
internalization_rounds = 3
# 内化阶段模型温度（越高越发散；0.3~0.5 推荐）
temperature = 0.35
# 内化阶段 token 上限：非常高会显著增加耗时与成本（同时也更“深入”）
max_tokens = 60000
# 固化思想检索衰减半衰期（天）：
# - 用于“注入/检索”时对旧思想做温和降权（避免旧思想长期霸占注入位）
# - 0 表示不衰减
thought_half_life_days = 30.0
# 固化思想最低衰减权重（0~1）：再老也至少保留这么多权重（避免永久失忆）
thought_min_decay = 0.25

[introspection]
# 触发间隔（分钟）：达到间隔且满足静默/有新消息等条件后，会运行一次“思维内省”
interval_minutes = 20.0
# 回顾窗口（分钟）：每次内省回看最近多少分钟的聊天摘要
window_minutes = 30.0
# 内省轮数：模拟“回想 → 理解 → 意识形态分析 → 结论”的多轮过程
rounds = 4
# 最少消息条数：只有当窗口内“可用消息”达到这个数量才会启动内省
# - 目的：避免只聊了几句就频繁内省（成本高且结论噪声大）
# - 说明：若存在待内化的思想种子（seed_queue），会绕过该阈值照常内省
min_messages_to_run = 30
# 每个会话最多纳入多少条脱敏消息（避免提示词过长/成本爆炸）
max_messages_per_group = 500
# 静默期（秒）：群里刚说完一阵子先别内省，等“冷却”后再总结
quiet_period_seconds = 20.0
# 每次 tick 最多处理多少个群/会话（保护性能）
max_groups_per_tick = 1
# 内省阶段模型温度（越高越发散）
temperature = 0.7
# 内省阶段 token 上限（越高越详细，也越贵）
max_tokens = 700
# 消息量强度缩放：聊天越多，偏移越可能被放大（建议保持默认）
window_strength_scale = 12.0
# 是否读取主程序 `config/bot_config.toml` 的 `[personality].personality` 作为“人格设定补充”
# - true：使用主程序人格设定（推荐）
# - false：不额外注入人格设定（仍会正常内省/内化）
use_main_personality = true
# 脱敏消息缓冲区上限（ON_MESSAGE 收集的摘要，等待被内省消费）
pending_max_messages = 600
# 内省日志条目上限（用于前端展示的“内心独白/轮次结果”）
max_log_items = 300

[injection]
# 是否在回复时注入“档位倾向 + 固化思想摘要”
# - 关闭后仍会运行内省/持久化，但不会改变 replyer 的提示词
enabled = true
# 注入策略：
# - "auto"：自动判断（工具/代码类问题更偏“只注入光谱”；观点/立场类更偏“注入思想”）
# - "full"：总是尝试注入固化思想（命中才注入）
# - "spectrum_only"：只注入光谱，不注入固化思想详情
policy = "auto"
# 只有当“相关性分数 >= min_thought_score”时，才会注入某条固化思想（0 表示只要命中就可注入）
min_thought_score = 0.0
# 注入最多带上多少条固化思想（越大越强影响，也越容易变啰嗦）
max_thought_details = 2
# 注入内容最大字符数（防止把提示词撑爆）
max_chars = 1400
# 是否在 planner 阶段也注入“思想光谱倾向”（让 planner 的动作选择/回复策略与立场联动）
# - true：planner 在选择 reply/no_reply 等动作时会参考当前光谱倾向
# - false：只影响 replyer，不影响 planner
apply_to_planner = true
# planner 注入块最大字符数（建议保持较小，避免影响 planner prompt）
planner_max_chars = 900

[persistence]
# 是否持久化状态到 JSON（建议开启，否则重启即丢立场/思维阁）
enabled = true
# 写盘间隔（秒）：越小越安全但更频繁 IO
save_interval_seconds = 15.0
# 导入/导出（用于迁移/备份）：
# - 导出：HTTP `GET /api/v1/soul/export`（只读、已脱敏，不含 pending_messages 全文）
# - 导入：仅支持“本地文件导入”，避免远程写状态风险
#
# 启动时导入（默认关闭）：
# 1) 把导出的 JSON 放到 `plugins/MaiBot_Soul_Engine/data/import.json`（或自定义路径）
# 2) 开启 import_on_start=true
# 3) 重启 MaiBot（导入成功后文件会被改名为 `.imported.<ts>`）
import_on_start = false
# 导入文件路径：留空则使用 `data/import.json`
import_path = ""
# 导入模式：
# - "merge"：合并到现有状态（要求 salt 一致；避免哈希体系混乱）
# - "overwrite"：覆盖现有状态（会采用导入文件的 salt 与 groups）
import_mode = "merge"

[performance]
# 单条消息摘要最大长度（会先脱敏再截断）；过长会抬高提示词成本
max_message_chars = 800
# 提示词总字符预算：聊天窗口过大时会自动“分段总结/降级”，防止超上下文导致失败
prompt_budget_chars = 120000
# 分段总结：每段输入字符预算（越大越少段，但单次请求更大更慢）
summary_chunk_chars = 7000
# 回复阶段提示词预算：用于限制“注入块”追加，避免把 replyer prompt 推爆
reply_prompt_budget_chars = 120000
# 注入预留安全字符数：给主程序留空间（避免临界超上下文）
reply_injection_safety_chars = 2000

[runtime]
# 运行时注入：一般不需要改。留空表示自动使用插件目录。
plugin_dir = ""

[debug]
# 命令开关：开启后允许使用 `/soul ...` 在聊天里查看状态/光谱/思维阁（不依赖前端）
# 常用：
# - `/soul status`    状态（类似 WebUI /pulse）
# - `/soul spectrum`  思想光谱
# - `/soul cabinet`   思维阁（固化思想/种子队列）
# - `/soul logs 12`   最近 12 条内省日志
# - `/soul targets`   列出可用 stream_id（用于私聊查看群状态）
# - `/soul injection` 最近一次注入命中信息
#
# 注意：
# - 命令默认只建议管理员使用；生产环境建议保持关闭，或只对白名单开放
enabled = false
# admin_only=true 时，仅 admin_user_ids 可执行调试命令
admin_only = true
# 允许执行调试命令的用户 ID 列表（TOML 数组，元素为字符串）
# 支持两种格式（二选一即可）：
# 1) 仅 user_id：`"123456"`
# 2) platform:user_id：`"qq:123456"`（推荐：多平台/防冲突）
#
# 其中：
# - `platform` 来自主程序消息里的 `message_info.platform`（以实际平台名为准）
# - `user_id` 来自 `message_info.user_info.user_id`
#
# 示例：
# admin_user_ids = ["123456", "qq:987654321", "telegram:123456789"]
admin_user_ids = []
# 是否允许 `/soul introspect` 强制内省（会写状态；生产环境默认关闭）
allow_force_introspect = false
# 是否写入审计日志（`data/audit.jsonl`；会做大小轮转）
audit_enabled = true
# 审计日志最大字节数（超出会轮转到 `audit.jsonl.bak`）
audit_max_bytes = 2000000
# 是否记录 API 调用日志（默认关闭；打开后日志可能非常频繁）
# - WebUI 会定时轮询 `/api/v1/soul/pulse`
# - 推荐仅在排查“前端连不上/鉴权失败/跨域问题”等场景时短期开启
log_api_calls = false
# 是否记录内省调度日志（默认关闭）
# - 用于排查“为什么一直不触发内省”（会输出 scheduler skip 原因）
# - 频率：每个群/会话每 60 秒最多 1 条
log_scheduler = false
# 是否记录注入摘要日志（默认关闭）
# - 开启后会输出 planner/replyer 注入摘要（每次注入都会打，可能很频繁）
log_injection = false
# 是否记录持久化日志（默认关闭）
# - 开启后每次保存 `data/state.json` 都会输出一条摘要（频率由 save_interval_seconds 决定）
log_persistence = false
